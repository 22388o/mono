import { useEffect, useState } from "react";
import { 
	Button, 
	Card, 
	Container, 
	Table 
} from "semantic-ui-react";
import { useAppSelector } from "../hooks.js";
import { 
	clearSwapInfo, 
	setSwapStatus 
} from "../slices/swapSlice.js";
import { SwapForm } from './SwapForm.jsx'
import { useAppDispatch } from "../hooks.js";
import { 
	removeLatestSwap, 
	updateSwapStatus 
} from "../slices/historySlice.js";
import { useNavigate } from "react-router-dom";

export const SwapDemo = () => {
	const navigate = useNavigate();
	const dispatch = useAppDispatch();
	const swapIndex = useAppSelector(state => state.swap.index);
	const amountBase = useAppSelector(state => state.swap.amountBase);
	const amountQuote = useAppSelector(state => state.swap.amountQuote);
	const swapState = useAppSelector(state => state.swap.swapState);
	const swapId = useAppSelector(state => state.swap.swapId);
	const swapHash = useAppSelector(state => state.swap.swapHash);
	const secretSeekerId = useAppSelector(state => state.swap.secretSeekerId);
	const secretHolderId = useAppSelector(state => state.swap.secretHolderId);
	const secret = useAppSelector(state => state.swap.secret);
	const request1 = useAppSelector(state => state.swap.request1);
	const request2 = useAppSelector(state => state.swap.request2);
	const commit1 = useAppSelector(state => state.swap.commit1);
	const commit2 = useAppSelector(state => state.swap.commit2);

	const [alice, setAlice] = useState({
		state: {
			isSecretHolder: false,
			left: {
				client: 'ln-client',
				node: 'lnd',
				request: null,
				clientInfo: {
						cert: '2d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d4949434a6a4343416332674177494241674952414f4770693476644b453173312b4464534277716e316377436759494b6f5a497a6a3045417749774d5445660a4d4230474131554543684d576247356b494746316447396e5a57356c636d46305a575167593256796444454f4d4177474131554541784d4659577870593255770a4868634e4d6a4d774d5445784d6a45794e7a51325768634e4d6a51774d7a41334d6a45794e7a5132576a41784d523877485159445651514b45785a73626d51670a595856306232646c626d56795958526c5a43426a5a584a304d51347744415944565151444577566862476c6a5a54425a4d424d4742797147534d3439416745470a43437147534d3439417745484130494142416b3931536743436b526e3231684c3572382f34446a5a50766b2f3342684b50545731476334494f3548366a3754420a376266435462756d695a3259744468747155535362434e7038507051356c45496b363661626c476a676355776763497744675944565230504151482f424151440a41674b6b4d424d47413155644a51514d4d416f47434373474151554642774d424d41384741315564457745422f7751464d414d4241663877485159445652304f0a4242594546496b4a7a7459716479366f4f6253704a376c2f2b5a5a734b62395a4d477347413155644551526b4d474b434257467361574e6c67676c7362324e680a62476876633353434257467361574e6c6767357762327868636931754e53316862476c6a5a594945645735706549494b64573570654842685932746c644949480a596e566d59323975626f6345667741414159635141414141414141414141414141414141414141414159634572426341416a414b42676771686b6a4f505151440a41674e484144424541694141756e715743334e504557435a484b7052326a5763556d3666394c4c59544d79527241382b5774516f4b7749674e6e4a68396944360a774d56554e2b777859333358336d39634e4651626c7430724272657646312b58704c593d0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a',
						adminMacaroon: '0201036c6e6402f801030a10db3bb9bca2eae77a0d62f80d979532041201301a160a0761646472657373120472656164120577726974651a130a04696e666f120472656164120577726974651a170a08696e766f69636573120472656164120577726974651a210a086d616361726f6f6e120867656e6572617465120472656164120577726974651a160a076d657373616765120472656164120577726974651a170a086f6666636861696e120472656164120577726974651a160a076f6e636861696e120472656164120577726974651a140a057065657273120472656164120577726974651a180a067369676e6572120867656e657261746512047265616400000620be48ba753d6ea86afdcc2fecb36d2af423be25e08ae799405b063ba042ba5a4e',
						invoiceMacaroon: '0201036c6e640258030a10d93bb9bca2eae77a0d62f80d979532041201301a160a0761646472657373120472656164120577726974651a170a08696e766f69636573120472656164120577726974651a0f0a076f6e636861696e120472656164000006205bce4216e39a5ff028b7b79fb0be414f114940afb7d112211620fddf53dff4f5',
						socket: 'localhost:10002'
					},
					lnd: {
						admin: null,
						invoice: null
					}
				},
				right: {
					client: 'ln-client',
					node: 'lnd',
					request: null,
					clientInfo: {
						cert: '2d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d4949434a544343416379674177494241674951562f684232645266495075394d62677a31544639467a414b42676771686b6a4f50515144416a41784d5238770a485159445651514b45785a73626d5167595856306232646c626d56795958526c5a43426a5a584a304d51347744415944565151444577566862476c6a5a5441650a467730794d7a41784d5445794d544d784d6a5661467730794e44417a4d4463794d544d784d6a56614d444578487a416442674e5642416f54466d78755a4342680a645852765a3256755a584a686447566b49474e6c636e5178446a414d42674e5642414d544257467361574e6c4d466b77457759484b6f5a497a6a3043415159490a4b6f5a497a6a30444151634451674145363546566d6246496e507437366b596e3474346d574b54654b32653864726866696837566a697a435176356a626833730a334f5631574e504f727a584b703465665237704e63694c586a7746393141486d4232714f53614f4278544342776a414f42674e56485138424166384542414d430a41715177457759445652306c42417777436759494b775942425155484177457744775944565230544151482f42415577417745422f7a416442674e56485134450a4667515571374e736b6a664d3568684963464c377030536245546c792b684577617759445652305242475177596f4946595778705932574343577876593246730a6147397a644949465957787059325743446e4276624746794c5734324c57467361574e6c67675231626d6c3467677031626d6c346347466a61325630676764690a64575a6a623235756877522f4141414268784141414141414141414141414141414141414141414268775373474141434d416f4743437147534d343942414d430a413063414d45514349424b644a617a364530786f6e48527641334641596b4d78612b2b714f484868614f355533544945427955414169425871336a764c70754c0a34615666326d314b316c6373586439442f4d6d38494a342b72336c476839664675673d3d0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a',
						adminMacaroon: '0201036c6e6402f801030a10f4980c846d9aa725afccf4252a140c141201301a160a0761646472657373120472656164120577726974651a130a04696e666f120472656164120577726974651a170a08696e766f69636573120472656164120577726974651a210a086d616361726f6f6e120867656e6572617465120472656164120577726974651a160a076d657373616765120472656164120577726974651a170a086f6666636861696e120472656164120577726974651a160a076f6e636861696e120472656164120577726974651a140a057065657273120472656164120577726974651a180a067369676e6572120867656e6572617465120472656164000006201611db347165857ced69e1fe060f58bbf8c6c046ffb16491dceae968b15f1ce9',
						invoiceMacaroon: '0201036c6e640258030a10f2980c846d9aa725afccf4252a140c141201301a160a0761646472657373120472656164120577726974651a170a08696e766f69636573120472656164120577726974651a0f0a076f6e636861696e12047265616400000620708346b8ba0747593e74399fcc5968678fe1b408ee48101d817fd0c96fd51203',
						socket: 'localhost:10001'
					},
					lnd: {
						admin: null,
						invoice: null
					}
				}
			}
		})
	const [carol, setCarol] = useState({
		state: {
				isSecretHolder: true,
				secret: secret,
				left: {
					client: 'ln-client',
					node: 'lnd',
					request: null,
					clientInfo: {
						cert: '2d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d4949434a5443434163796741774942416749514c5357665268787366634136346e6435556e727a427a414b42676771686b6a4f50515144416a41784d5238770a485159445651514b45785a73626d5167595856306232646c626d56795958526c5a43426a5a584a304d51347744415944565151444577566a59584a76624441650a467730794d7a41784d5445794d5449334e445a61467730794e44417a4d4463794d5449334e445a614d444578487a416442674e5642416f54466d78755a4342680a645852765a3256755a584a686447566b49474e6c636e5178446a414d42674e5642414d5442574e68636d39734d466b77457759484b6f5a497a6a3043415159490a4b6f5a497a6a30444151634451674145702f797274494378574733734e4a503167466937686965534e446b58646557596346465153543331504a7051777341480a5031476a626f6b6c4a686135677878424969772f6773703157446e4b4d33744b774e556942714f4278544342776a414f42674e56485138424166384542414d430a41715177457759445652306c42417777436759494b775942425155484177457744775944565230544151482f42415577417745422f7a416442674e56485134450a46675155622b73796d636838667a506c65776931434d504453545163766b6377617759445652305242475177596f4946593246796232794343577876593246730a6147397a644949465932467962327943446e4276624746794c5734314c574e68636d397367675231626d6c3467677031626d6c346347466a61325630676764690a64575a6a623235756877522f4141414268784141414141414141414141414141414141414141414268775373467741464d416f4743437147534d343942414d430a413063414d455143495144722f32312f50512f754e763849385730575837754748483149362f314b412f335a696f746439664a664e7749664243716c7253426f0a46332f59704667384363526a426551306c6e52546d63325176372f386f58303038773d3d0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a',
						adminMacaroon: '0201036c6e6402f801030a1041cd19efb4a76c57b6326ccf55702cf31201301a160a0761646472657373120472656164120577726974651a130a04696e666f120472656164120577726974651a170a08696e766f69636573120472656164120577726974651a210a086d616361726f6f6e120867656e6572617465120472656164120577726974651a160a076d657373616765120472656164120577726974651a170a086f6666636861696e120472656164120577726974651a160a076f6e636861696e120472656164120577726974651a140a057065657273120472656164120577726974651a180a067369676e6572120867656e65726174651204726561640000062018d50fc883448885779efa5ba0d34b878b82f44b802ee7c1c3ddc4a1e1578eec',
						invoiceMacaroon: '0201036c6e640258030a103fcd19efb4a76c57b6326ccf55702cf31201301a160a0761646472657373120472656164120577726974651a170a08696e766f69636573120472656164120577726974651a0f0a076f6e636861696e1204726561640000062044810104e9d81473c230ca9743460121b978d743d2d6721b17b5305a8beedd19',
						socket: 'localhost:10004'
					},
					lnd: {
						admin: null,
						invoice: null
					}
				},
				right: {
						client: 'ln-client',
						node: 'lnd',
						request: null,
						clientInfo: {
								cert: '2d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d4949434a6a434341633267417749424167495241506c465955706d356b38525a63574138685a554d5a4177436759494b6f5a497a6a3045417749774d5445660a4d4230474131554543684d576247356b494746316447396e5a57356c636d46305a575167593256796444454f4d4177474131554541784d4659324679623277770a4868634e4d6a4d774d5445784d6a457a4d5449325768634e4d6a51774d7a41334d6a457a4d544932576a41784d523877485159445651514b45785a73626d51670a595856306232646c626d56795958526c5a43426a5a584a304d51347744415944565151444577566a59584a766244425a4d424d4742797147534d3439416745470a43437147534d343941774548413049414250794d7a6b524d4d77324a63785369634c6d5467774265424e62636e3172426c70546b6836496c786b596d632b52680a77475230796b776a42445857385a2b6b6a7a6975516e4b314c36373741394f556d7a4d3674622b6a676355776763497744675944565230504151482f424151440a41674b6b4d424d47413155644a51514d4d416f47434373474151554642774d424d41384741315564457745422f7751464d414d4241663877485159445652304f0a42425945464f554b6e4e654d57455a336a634b2b38525348464b4374354a4b494d477347413155644551526b4d474b4342574e68636d397367676c7362324e680a624768766333534342574e68636d39736767357762327868636931754e69316a59584a7662494945645735706549494b64573570654842685932746c644949480a596e566d59323975626f63456677414141596351414141414141414141414141414141414141414141596345724267414244414b42676771686b6a4f505151440a41674e48414442454169425a462b653244702b2f6c664f66685a4a564c615854425650356a2f596a4f6c623730314b3353634c754f674967474f5348473948630a4c58666a6c635930534a4d4c39663238455654573856353349336463475a737a5664673d0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a',
								adminMacaroon: '0201036c6e6402f801030a10e8f316d1657d6d0de80ec209ee955aa01201301a160a0761646472657373120472656164120577726974651a130a04696e666f120472656164120577726974651a170a08696e766f69636573120472656164120577726974651a210a086d616361726f6f6e120867656e6572617465120472656164120577726974651a160a076d657373616765120472656164120577726974651a170a086f6666636861696e120472656164120577726974651a160a076f6e636861696e120472656164120577726974651a140a057065657273120472656164120577726974651a180a067369676e6572120867656e65726174651204726561640000062065a36778704bb14f2cef4dd076cb7357e80b75160e984e687a403c32efd69fe8',
								invoiceMacaroon: '0201036c6e640258030a10e6f316d1657d6d0de80ec209ee955aa01201301a160a0761646472657373120472656164120577726974651a170a08696e766f69636573120472656164120577726974651a0f0a076f6e636861696e12047265616400000620ed59709452a103851e6cd8b5b346668705fff81c7c6a03185f7a48c6fbd79e0d',
								socket: 'localhost:10006'
						},
						lnd: {
								admin: null,
								invoice: null
						}
				}
		}
	})
	useEffect(() => {
		if(!swapState && swapHash) {
			dispatch(setSwapStatus(1));
			dispatch(updateSwapStatus({index: swapIndex, status: 1}));
		}
		if(swapState === 1 && ((request1 && !request2) || (!request1 && request2))) {
			dispatch(setSwapStatus(2));
			dispatch(updateSwapStatus({index: swapIndex, status: 2}));
		}
		if(swapState === 2 && request1 && request2){
			dispatch(setSwapStatus(3));
			dispatch(updateSwapStatus({index: swapIndex, status: 3}));
		}
		if(swapState === 3 && commit1 && !commit2){
			dispatch(setSwapStatus(4));
			dispatch(updateSwapStatus({index: swapIndex, status: 4}));
		}
		if(swapState === 4 && commit1 && commit2){
			dispatch(setSwapStatus(5));
			dispatch(updateSwapStatus({index: swapIndex, status: 5}));
		}
		// if() setSwapStatus(6)
	}, [swapHash, request1, request2, commit1, commit2, swapState]);

	useEffect(() => {
		if(swapState === 5) alert('Swap confirmed and secret hash revealed!');
	}, [swapState]);

	const onClearSwap = () => {
		dispatch(clearSwapInfo());
		if(swapState !== 5) dispatch(removeLatestSwap());
		navigate('/');
	};

	const onBackToHome = () => {
		navigate('/');
	};

	useEffect(() => {
		if(!swapId) navigate('/');
	}, [swapId]);

	return (
		<>
			<Card.Group className="flex-nowrap" centered>
				<Card fluid>
					<Card.Content>
						<Card.Header>
							Swap Info
						</Card.Header>
						<Card.Description>
							<Table style={{ border: "0px solid rgba(0,0,0,0)" }}>
								<Table.Body>
									<Table.Row>
										<Table.Cell>
											baseAmount: 
										</Table.Cell>
										<Table.Cell>
											<Container style={{ wordWrap: "break-word" }}>
												{amountBase}
											</Container>
										</Table.Cell>
									</Table.Row>
									<Table.Row>
										<Table.Cell>
											quoteAmount: 
										</Table.Cell>
										<Table.Cell>
											<Container style={{ wordWrap: "break-word" }}>
												{amountQuote}
											</Container>
										</Table.Cell>
									</Table.Row>
									<Table.Row>
										<Table.Cell>
											swapId: 
										</Table.Cell>
										<Table.Cell>
											<Container style={{ wordWrap: "break-word" }}>
												{swapId}
											</Container>
										</Table.Cell>
									</Table.Row>
									<Table.Row>
										<Table.Cell>
											invoice1: 
										</Table.Cell>
										<Table.Cell>
											<Container style={{ wordWrap: "break-word" }}>
												{request1}
											</Container>
										</Table.Cell>
									</Table.Row>
									<Table.Row>
										<Table.Cell>
											invoice2:
										</Table.Cell>
										<Table.Cell>
											<Container style={{ wordWrap: "break-word" }}>
												{request2}
											</Container>
										</Table.Cell>
									</Table.Row>
								</Table.Body>
							</Table>
							<Button onClick={onClearSwap}>{ swapState !== 5 ? 'Cancel Swap' : 'New Swap' }</Button> 
							{ swapState !== 5 && <Button onClick={onBackToHome}>Back to Home</Button> }
						</Card.Description>
					</Card.Content>
				</Card>
			</Card.Group>    
			<Card.Group widths='equal' className="flex-nowrap">
				<Card className="user-swap">
					<Card.Content>
						<SwapForm firstParty={true} participant={alice} id={secretSeekerId} />
					</Card.Content>
				</Card>
				<Card className="user-swap">
					<Card.Content>
						<SwapForm firstParty={false} participant={carol} id={secretHolderId} />
					</Card.Content>
				</Card>
			</Card.Group>
		</>
	);
}
