<html>

<head>
    <script src="
    https://cdn.jsdelivr.net/npm/@metamask/legacy-web3@2.0.0/dist/metamask.web3.min.js
    "></script>
</head>

<body>
    <h1>Send L2 payment</h1>

    Your Address<br /><button id="connect" onclick="connect()">Connect Web3</button>
    <span id="address"></span><br />

    <br />
    Target Address<br />
    <input id="target" value="0x8584223Ea6Bd70d30FbA40175595F0F09a61cA2a" /><br />

    <!--br />
    Channel Id <br />
    <span id="channel"></span><br /-->

    Your Balance
    <span id="balance"></span><br /><br />

    <!--Channel <br />
    <input id="channel" value="0xce1285848482e532d3dc47fa492e8269d3f4365377491cee04de4d6af995331a" /><br />-->
    
    Payment Amount <br />
    <input id="amount" value="55" /><br />    
    <button id="send" onclick="sendPayment()">Send</button>
</body>

<script>
channelContractAddress = '0xf7aC6619aB81D8E0e06f573d3A9c0E14983C15D7';
ETH =  '0x0000000000000000000000000000000000000000';
baseRpcUrl = `http://localhost:3000`;

function getChannelId(sourceAddress, targetAddress, tokenAddress='0x00'){  
    //TODO include token in channel id preimage              
    let buffer = concatHex(channelContractAddress, sourceAddress, targetAddress); //, tokenAddress
    return web3.sha3(buffer, {encoding: 'hex'});
}

function concatHex(){
    var args = Array.prototype.slice.call(arguments);
    return '0x' + args.map(x => x.startsWith('0x') ? x.substr(2) : x ).join('');
}

function decToUint256Hex(value){
    let res = parseInt(value).toString(16).padStart(64, '0');        
    return res;
}

function encodeTransferForSig(params){            
    let message = concatHex(channelContractAddress, params.channelId, decToUint256Hex(params.spent));        
    console.log("ENCODED TX", message);

    let hash = web3.sha3(message, {encoding: 'hex'}); //this.web3new.utils.keccak256(message);

    console.log("ENCODED TX HASH", hash);

    return hash;
}


async function sendAjax(url) {
    return new Promise((resolve, reject) =>{
        // Creating Our XMLHttpRequest object 
        var xhr = new XMLHttpRequest();

        // Making our connection                  
        xhr.open("GET", url, true);

        // function execute after request is successful 
        xhr.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                //console.log(this.responseText);
                console.log("AJAX RESULT",this.responseText);
                let result = JSON.parse(this.responseText);                
                resolve(result);
            }

            if(this.status != 200){
                reject("failed ajax call");
            }
        }
        // Sending our request 
        xhr.send();
    });
}

function getParams(params){
    return Object.keys(params).map(k => k + '=' + params[k]).join('&')
}

async function sendPayment(){
    //let chan = document.getElementById('channel').value;
    let amount = document.getElementById('amount').value;
    let target = document.getElementById('target').value;
    let token = ETH;

    let myaddress = web3.eth.accounts[0];

    let channelId = getChannelId(myaddress, target);

    //if(channelId != chan) throw "wrong computed channel";

    let encoded = encodeTransferForSig({
        channelId: channelId,
        spent: amount
    })

    const signature = await ethereum.request({ method: 'personal_sign', params: [ encoded, myaddress ] });

    console.log("SIG", signature);

    let transferUrl = baseRpcUrl + `/transfer?` + getParams({
        target: target,
        amount: amount,
        token: token,
        signature: signature,
    });
    console.log("TRANSFER URL", transferUrl)
    let transfer = await sendAjax(transferUrl);

    console.log("TRANSFER", transfer);

    if(transfer.status === 'success'){
        setTimeout(async () => {
            let revealUrl = baseRpcUrl + '/reveal?' + getParams({secret: transfer.secret})
            console.log("REVEALING SECRET", revealUrl);
            let revealed = await sendAjax(revealUrl);
            console.log("REVEALED", revealed);
        }, 1500)
    }
    
}
</script>

<script>

async function connect() {
 if (window.ethereum) {
 
  await window.ethereum.request({ method: "eth_requestAccounts" });
  window.web3 = new Web3(window.ethereum);
  
 } else {
  console.log("No wallet");
 }
}

window.addEventListener('load', function() {


    // Load WEB3
    // Check wether it's already injected by something else (like Metamask or Parity Chrome plugin)
    if(typeof web3 !== 'undefined') {
        console.log("USING INJECTED WEB3");
        web3 = new Web3(web3.currentProvider);  

    // Or connect to a node
    } else {
        web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
    }

    // Check the connection
    if(!web3.isConnected()) {
        console.error("Not connected");

    }

    var account = web3.eth.accounts[0];
    var accountInterval = setInterval(function() {
        if (web3.eth.accounts[0] !== account) {
            account = web3.eth.accounts[0];
            document.getElementById("address").innerHTML = account;
        }
    }, 100);

    //document.getElementById('channel').innerHTML = getChannelId();

});

</script>

</html>